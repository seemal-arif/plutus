<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds  #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GADTs            #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase       #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell  #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies     #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators    #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns     #-}</span><span>
</span><span id="line-9"></span><span class="hs-comment">{- |
An inlining pass.

This pass is essentially a copy of the PIR inliner, and should be KEPT IN SYNC with it.
It's hard to do this with true abstraction, so we just have to keep two copies reasonably
similar.

However, there are some differences. In the interests of making it easier to keep
things in sync, these are explicitly listed in Note [Differences from PIR inliner].
If you add another difference, please note it there! Obviously fewer differences is
better.

See Note [The problem of inlining destructors].
-}</span><span>
</span><span id="line-23"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">UntypedPlutusCore.Transform.Inline</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#inline"><span class="hs-identifier">inline</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Annotation.html#InlineHints"><span class="hs-identifier">InlineHints</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Rename.html"><span class="hs-identifier">PlutusCore.Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Rename.Internal.html#Dupable"><span class="hs-identifier">Dupable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Rename.html#dupable"><span class="hs-identifier">dupable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Rename.html#liftDupable"><span class="hs-identifier">liftDupable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusPrelude.html"><span class="hs-identifier">PlutusPrelude</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Analysis.Usages.html"><span class="hs-identifier">UntypedPlutusCore.Analysis.Usages</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Usages</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Plated.html"><span class="hs-identifier">UntypedPlutusCore.Core.Plated</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html"><span class="hs-identifier">UntypedPlutusCore.Core.Type</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.MkUPlc.html"><span class="hs-identifier">UntypedPlutusCore.MkUPlc</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Rename.html"><span class="hs-identifier">UntypedPlutusCore.Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.html"><span class="hs-identifier">PlutusCore</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Annotation.html"><span class="hs-identifier">PlutusCore.Annotation</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.html"><span class="hs-identifier">PlutusCore.Builtin</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PLC</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Name.html"><span class="hs-identifier">PlutusCore.Name</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Quote.html"><span class="hs-identifier">PlutusCore.Quote</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Control.Lens</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../lens/html/src"><span class="hs-identifier">Strict</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier">Control.Monad.Reader</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier">Control.Monad.State</span></a></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../semigroups/html/src"><span class="hs-identifier">Data.Semigroup.Generic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../semigroups/html/src"><span class="hs-identifier">GenericSemigroupMonoid</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../witherable/html/src"><span class="hs-identifier">Witherable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../witherable/html/src"><span class="hs-identifier">wither</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-comment">{- Note [Differences from PIR inliner]

1. No types (obviously).
2. No strictness information (we only have lambda arguments, which are always strict).
3. Handling of multiple beta-reductions in one go, this is handled in PIR by a dedicated pass.
4. Don't inline lambdas with small bodies. We do this in PIR but we *probably* shouldn't really.
But doing it here is actively harmful, so we don't include it.
5. Simplistic purity analysis, in particular we don't try to be clever about builtins
(should mostly be handled in PIR).
-}</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-comment">-- | Substitution range, 'SubstRng' in the paper.</span><span>
</span><span id="line-58"></span><span class="hs-keyword">newtype</span><span> </span><span id="InlineTerm"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-var">InlineTerm</span></a></span></span><span> </span><span id="local-6989586621681179497"><span class="annot"><a href="#local-6989586621681179497"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179496"><span class="annot"><a href="#local-6989586621681179496"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179495"><span class="annot"><a href="#local-6989586621681179495"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179494"><span class="annot"><a href="#local-6989586621681179494"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Done"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#Done"><span class="hs-identifier hs-var">Done</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Rename.Internal.html#Dupable"><span class="hs-identifier hs-type">Dupable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179497"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179496"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179495"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179494"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">-- | Term substitution, 'Subst' in the paper.</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- A map of unprocessed variable and its substitution range.</span><span>
</span><span id="line-62"></span><span class="hs-keyword">newtype</span><span> </span><span id="TermEnv"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#TermEnv"><span class="hs-identifier hs-var">TermEnv</span></a></span></span><span> </span><span id="local-6989586621681179832"><span class="annot"><a href="#local-6989586621681179832"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179831"><span class="annot"><a href="#local-6989586621681179831"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179830"><span class="annot"><a href="#local-6989586621681179830"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179829"><span class="annot"><a href="#local-6989586621681179829"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-63"></span><span>    </span><span id="TermEnv"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#TermEnv"><span class="hs-identifier hs-var">TermEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_unTermEnv"><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
TermEnv name uni fun a
-&gt; UniqueMap TermUnique (InlineTerm name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#_unTermEnv"><span class="hs-identifier hs-var hs-var">_unTermEnv</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#UniqueMap"><span class="hs-identifier hs-type">PLC.UniqueMap</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179832"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179831"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179830"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179829"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681179404"><span id="local-6989586621681179410"><span id="local-6989586621681179415"><span class="annot"><span class="annottext">NonEmpty (TermEnv name uni fun a) -&gt; TermEnv name uni fun a
TermEnv name uni fun a
-&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
forall b.
Integral b =&gt;
b -&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
forall a.
(a -&gt; a -&gt; a)
-&gt; (NonEmpty a -&gt; a)
-&gt; (forall b. Integral b =&gt; b -&gt; a -&gt; a)
-&gt; Semigroup a
forall name (uni :: * -&gt; *) fun a.
NonEmpty (TermEnv name uni fun a) -&gt; TermEnv name uni fun a
forall name (uni :: * -&gt; *) fun a.
TermEnv name uni fun a
-&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
forall name (uni :: * -&gt; *) fun a b.
Integral b =&gt;
b -&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
stimes :: forall b.
Integral b =&gt;
b -&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
$cstimes :: forall name (uni :: * -&gt; *) fun a b.
Integral b =&gt;
b -&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
sconcat :: NonEmpty (TermEnv name uni fun a) -&gt; TermEnv name uni fun a
$csconcat :: forall name (uni :: * -&gt; *) fun a.
NonEmpty (TermEnv name uni fun a) -&gt; TermEnv name uni fun a
&lt;&gt; :: TermEnv name uni fun a
-&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
$c&lt;&gt; :: forall name (uni :: * -&gt; *) fun a.
TermEnv name uni fun a
-&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Semigroup</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681179385"><span id="local-6989586621681179389"><span id="local-6989586621681179394"><span class="annot"><span class="annottext">TermEnv name uni fun a
[TermEnv name uni fun a] -&gt; TermEnv name uni fun a
TermEnv name uni fun a
-&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
forall a.
Semigroup a -&gt; a -&gt; (a -&gt; a -&gt; a) -&gt; ([a] -&gt; a) -&gt; Monoid a
forall name (uni :: * -&gt; *) fun a.
Semigroup (TermEnv name uni fun a)
forall name (uni :: * -&gt; *) fun a. TermEnv name uni fun a
forall name (uni :: * -&gt; *) fun a.
[TermEnv name uni fun a] -&gt; TermEnv name uni fun a
forall name (uni :: * -&gt; *) fun a.
TermEnv name uni fun a
-&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
mconcat :: [TermEnv name uni fun a] -&gt; TermEnv name uni fun a
$cmconcat :: forall name (uni :: * -&gt; *) fun a.
[TermEnv name uni fun a] -&gt; TermEnv name uni fun a
mappend :: TermEnv name uni fun a
-&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
$cmappend :: forall name (uni :: * -&gt; *) fun a.
TermEnv name uni fun a
-&gt; TermEnv name uni fun a -&gt; TermEnv name uni fun a
mempty :: TermEnv name uni fun a
$cmempty :: forall name (uni :: * -&gt; *) fun a. TermEnv name uni fun a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monoid</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-comment">-- | Wrapper of term substitution so that it's similar to the PIR inliner.</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- See Note [Differences from PIR inliner] 1</span><span>
</span><span id="line-68"></span><span id="local-6989586621681179379"><span id="local-6989586621681179380"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="Subst"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span></span><span> </span><span id="local-6989586621681179796"><span class="annot"><a href="#local-6989586621681179796"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179795"><span class="annot"><a href="#local-6989586621681179795"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179794"><span class="annot"><a href="#local-6989586621681179794"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179793"><span class="annot"><a href="#local-6989586621681179793"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Subst"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#Subst"><span class="hs-identifier hs-var">Subst</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_termEnv"><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
Subst name uni fun a -&gt; TermEnv name uni fun a
</span><a href="UntypedPlutusCore.Transform.Inline.html#_termEnv"><span class="hs-identifier hs-var hs-var">_termEnv</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#TermEnv"><span class="hs-identifier hs-type">TermEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179796"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179795"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179794"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179793"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall name (uni :: * -&gt; *) fun a x.
Rep (Subst name uni fun a) x -&gt; Subst name uni fun a
forall name (uni :: * -&gt; *) fun a x.
Subst name uni fun a -&gt; Rep (Subst name uni fun a) x
$cto :: forall name (uni :: * -&gt; *) fun a x.
Rep (Subst name uni fun a) x -&gt; Subst name uni fun a
$cfrom :: forall name (uni :: * -&gt; *) fun a x.
Subst name uni fun a -&gt; Rep (Subst name uni fun a) x
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681179356"><span id="local-6989586621681179364"><span id="local-6989586621681179371"><span class="annot"><span class="annottext">NonEmpty (Subst name uni fun a) -&gt; Subst name uni fun a
Subst name uni fun a
-&gt; Subst name uni fun a -&gt; Subst name uni fun a
forall b.
Integral b =&gt;
b -&gt; Subst name uni fun a -&gt; Subst name uni fun a
forall a.
(a -&gt; a -&gt; a)
-&gt; (NonEmpty a -&gt; a)
-&gt; (forall b. Integral b =&gt; b -&gt; a -&gt; a)
-&gt; Semigroup a
forall name (uni :: * -&gt; *) fun a.
NonEmpty (Subst name uni fun a) -&gt; Subst name uni fun a
forall name (uni :: * -&gt; *) fun a.
Subst name uni fun a
-&gt; Subst name uni fun a -&gt; Subst name uni fun a
forall name (uni :: * -&gt; *) fun a b.
Integral b =&gt;
b -&gt; Subst name uni fun a -&gt; Subst name uni fun a
stimes :: forall b.
Integral b =&gt;
b -&gt; Subst name uni fun a -&gt; Subst name uni fun a
$cstimes :: forall name (uni :: * -&gt; *) fun a b.
Integral b =&gt;
b -&gt; Subst name uni fun a -&gt; Subst name uni fun a
sconcat :: NonEmpty (Subst name uni fun a) -&gt; Subst name uni fun a
$csconcat :: forall name (uni :: * -&gt; *) fun a.
NonEmpty (Subst name uni fun a) -&gt; Subst name uni fun a
&lt;&gt; :: Subst name uni fun a
-&gt; Subst name uni fun a -&gt; Subst name uni fun a
$c&lt;&gt; :: forall name (uni :: * -&gt; *) fun a.
Subst name uni fun a
-&gt; Subst name uni fun a -&gt; Subst name uni fun a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Semigroup</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681179315"><span id="local-6989586621681179321"><span id="local-6989586621681179328"><span class="annot"><span class="annottext">Subst name uni fun a
[Subst name uni fun a] -&gt; Subst name uni fun a
Subst name uni fun a
-&gt; Subst name uni fun a -&gt; Subst name uni fun a
forall a.
Semigroup a -&gt; a -&gt; (a -&gt; a -&gt; a) -&gt; ([a] -&gt; a) -&gt; Monoid a
forall name (uni :: * -&gt; *) fun a. Semigroup (Subst name uni fun a)
forall name (uni :: * -&gt; *) fun a. Subst name uni fun a
forall name (uni :: * -&gt; *) fun a.
[Subst name uni fun a] -&gt; Subst name uni fun a
forall name (uni :: * -&gt; *) fun a.
Subst name uni fun a
-&gt; Subst name uni fun a -&gt; Subst name uni fun a
mconcat :: [Subst name uni fun a] -&gt; Subst name uni fun a
$cmconcat :: forall name (uni :: * -&gt; *) fun a.
[Subst name uni fun a] -&gt; Subst name uni fun a
mappend :: Subst name uni fun a
-&gt; Subst name uni fun a -&gt; Subst name uni fun a
$cmappend :: forall name (uni :: * -&gt; *) fun a.
Subst name uni fun a
-&gt; Subst name uni fun a -&gt; Subst name uni fun a
mempty :: Subst name uni fun a
$cmempty :: forall name (uni :: * -&gt; *) fun a. Subst name uni fun a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monoid</span></a></span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../semigroups/html/src"><span class="hs-identifier hs-type">GenericSemigroupMonoid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179796"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179795"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179794"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179793"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span id="unTermEnv"><span id="local-6989586621681179758"><span id="local-6989586621681179759"><span id="local-6989586621681179760"><span id="local-6989586621681179761"><span id="local-6989586621681179829"><span id="local-6989586621681179830"><span id="local-6989586621681179831"><span id="local-6989586621681179832"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">TermEnv</span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-73"></span><span id="termEnv"><span id="local-6989586621681179742"><span id="local-6989586621681179743"><span id="local-6989586621681179744"><span id="local-6989586621681179745"><span id="local-6989586621681179793"><span id="local-6989586621681179794"><span id="local-6989586621681179795"><span id="local-6989586621681179796"><span class="hs-identifier">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Subst</span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">type</span><span> </span><span id="ExternalConstraints"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#ExternalConstraints"><span class="hs-identifier hs-var">ExternalConstraints</span></a></span></span><span> </span><span id="local-6989586621681179276"><span class="annot"><a href="#local-6989586621681179276"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179275"><span class="annot"><a href="#local-6989586621681179275"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179274"><span class="annot"><a href="#local-6989586621681179274"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179273"><span class="annot"><a href="#local-6989586621681179273"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179276"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179276"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179275"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179274"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Quote.html#MonadQuote"><span class="hs-identifier hs-type">MonadQuote</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179273"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-keyword">type</span><span> </span><span id="InliningConstraints"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-var">InliningConstraints</span></a></span></span><span> </span><span id="local-6989586621681179272"><span class="annot"><a href="#local-6989586621681179272"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179271"><span class="annot"><a href="#local-6989586621681179271"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179270"><span class="annot"><a href="#local-6989586621681179270"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179272"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179272"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">PLC.ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179271"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179270"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">-- See Note [Differences from PIR inliner] 2</span><span>
</span><span id="line-89"></span><span class="hs-keyword">data</span><span> </span><span id="InlineInfo"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-var">InlineInfo</span></a></span></span><span> </span><span id="local-6989586621681179735"><span class="annot"><a href="#local-6989586621681179735"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179734"><span class="annot"><a href="#local-6989586621681179734"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InlineInfo"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-var">InlineInfo</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_usages"><span class="annot"><span class="annottext">forall name a. InlineInfo name a -&gt; Usages
</span><a href="UntypedPlutusCore.Transform.Inline.html#_usages"><span class="hs-identifier hs-var hs-var">_usages</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Analysis.Usages.html#Usages"><span class="hs-identifier hs-type">Usages.Usages</span></a></span><span class="hs-special">,</span><span> </span><span id="_hints"><span class="annot"><span class="annottext">forall name a. InlineInfo name a -&gt; InlineHints name a
</span><a href="UntypedPlutusCore.Transform.Inline.html#_hints"><span class="hs-identifier hs-var hs-var">_hints</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Annotation.html#InlineHints"><span class="hs-identifier hs-type">InlineHints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179735"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179734"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">-- Using a concrete monad makes a very large difference to the performance of this module</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- (determined from profiling)</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- | The monad the inliner runs in.</span><span>
</span><span id="line-94"></span><span class="hs-keyword">type</span><span> </span><span id="InlineM"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-var">InlineM</span></a></span></span><span> </span><span id="local-6989586621681179266"><span class="annot"><a href="#local-6989586621681179266"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179265"><span class="annot"><a href="#local-6989586621681179265"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179264"><span class="annot"><a href="#local-6989586621681179264"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179263"><span class="annot"><a href="#local-6989586621681179263"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier hs-type">ReaderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-type">InlineInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179266"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179263"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../transformers/html/src"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179266"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179265"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179264"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179263"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PlutusCore.Quote.html#Quote"><span class="hs-identifier hs-type">Quote</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- | Look up the unprocessed variable in the substitution.</span><span>
</span><span id="line-97"></span><span id="local-6989586621681179722"><span id="local-6989586621681179723"><span id="local-6989586621681179724"><span id="local-6989586621681179726"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#lookupTerm"><span class="hs-identifier hs-type">lookupTerm</span></a></span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179726"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681179726"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179726"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179724"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179723"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179722"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179726"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179724"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179723"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179722"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-102"></span><span id="lookupTerm"><span class="annot"><span class="annottext">lookupTerm :: forall name (uni :: * -&gt; *) fun a.
HasUnique name TermUnique =&gt;
name -&gt; Subst name uni fun a -&gt; Maybe (InlineTerm name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#lookupTerm"><span class="hs-identifier hs-var hs-var">lookupTerm</span></a></span></span><span> </span><span id="local-6989586621681179253"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179253"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681179252"><span class="annot"><span class="annottext">Subst name uni fun a
</span><a href="#local-6989586621681179252"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name unique a.
HasUnique name unique =&gt;
name -&gt; UniqueMap unique a -&gt; Maybe a
</span><a href="PlutusCore.Name.html#lookupName"><span class="hs-identifier hs-var">lookupName</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179253"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Subst name uni fun a
</span><a href="#local-6989586621681179252"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a name (uni :: * -&gt; *) fun a.
Iso
  (Subst name uni fun a)
  (Subst name uni fun a)
  (TermEnv name uni fun a)
  (TermEnv name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#termEnv"><span class="hs-identifier hs-var">termEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a name (uni :: * -&gt; *) fun a.
Iso
  (TermEnv name uni fun a)
  (TermEnv name uni fun a)
  (UniqueMap TermUnique (InlineTerm name uni fun a))
  (UniqueMap TermUnique (InlineTerm name uni fun a))
</span><a href="UntypedPlutusCore.Transform.Inline.html#unTermEnv"><span class="hs-identifier hs-var">unTermEnv</span></a></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">-- | Insert the unprocessed variable into the substitution.</span><span>
</span><span id="line-105"></span><span id="local-6989586621681179700"><span id="local-6989586621681179701"><span id="local-6989586621681179702"><span id="local-6989586621681179703"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#extendTerm"><span class="hs-identifier hs-type">extendTerm</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Name.html#HasUnique"><span class="hs-identifier hs-type">HasUnique</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179703"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TermUnique"><span class="hs-identifier hs-type">TermUnique</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681179703"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-comment">-- ^ The name of the variable.</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179703"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179702"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179701"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179700"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ The substitution range.</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179703"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179702"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179701"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179700"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-comment">-- ^ The substitution.</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#Subst"><span class="hs-identifier hs-type">Subst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179703"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179702"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179701"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179700"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-111"></span><span id="extendTerm"><span class="annot"><span class="annottext">extendTerm :: forall name (uni :: * -&gt; *) fun a.
HasUnique name TermUnique =&gt;
name
-&gt; InlineTerm name uni fun a
-&gt; Subst name uni fun a
-&gt; Subst name uni fun a
</span><a href="UntypedPlutusCore.Transform.Inline.html#extendTerm"><span class="hs-identifier hs-var hs-var">extendTerm</span></a></span></span><span> </span><span id="local-6989586621681179240"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179240"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681179239"><span class="annot"><span class="annottext">InlineTerm name uni fun a
</span><a href="#local-6989586621681179239"><span class="hs-identifier hs-var">clos</span></a></span></span><span> </span><span id="local-6989586621681179238"><span class="annot"><span class="annottext">Subst name uni fun a
</span><a href="#local-6989586621681179238"><span class="hs-identifier hs-var">subst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Subst name uni fun a
</span><a href="#local-6989586621681179238"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a name (uni :: * -&gt; *) fun a.
Iso
  (Subst name uni fun a)
  (Subst name uni fun a)
  (TermEnv name uni fun a)
  (TermEnv name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#termEnv"><span class="hs-identifier hs-var">termEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a name (uni :: * -&gt; *) fun a.
Iso
  (TermEnv name uni fun a)
  (TermEnv name uni fun a)
  (UniqueMap TermUnique (InlineTerm name uni fun a))
  (UniqueMap TermUnique (InlineTerm name uni fun a))
</span><a href="UntypedPlutusCore.Transform.Inline.html#unTermEnv"><span class="hs-identifier hs-var">unTermEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../../../../lens/html/src"><span class="hs-operator hs-var">%~</span></a></span><span> </span><span class="annot"><span class="annottext">forall name unique a.
HasUnique name unique =&gt;
name -&gt; a -&gt; UniqueMap unique a -&gt; UniqueMap unique a
</span><a href="PlutusCore.Name.html#insertByName"><span class="hs-identifier hs-var">insertByName</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179240"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">InlineTerm name uni fun a
</span><a href="#local-6989586621681179239"><span class="hs-identifier hs-var">clos</span></a></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-comment">-- | Inline simple bindings. Relies on global uniqueness, and preserves it.</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- See Note [Inlining and global uniqueness]</span><span>
</span><span id="line-115"></span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#inline"><span class="hs-identifier hs-type">inline</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681179684"><span class="annot"><a href="#local-6989586621681179684"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179683"><span class="annot"><a href="#local-6989586621681179683"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179682"><span class="annot"><a href="#local-6989586621681179682"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179681"><span class="annot"><a href="#local-6989586621681179681"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621681179679"><span class="annot"><a href="#local-6989586621681179679"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#ExternalConstraints"><span class="hs-identifier hs-type">ExternalConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179684"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179683"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179682"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179681"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Annotation.html#InlineHints"><span class="hs-identifier hs-type">InlineHints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179684"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179679"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179684"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179683"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179682"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179679"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681179681"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179684"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179683"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179682"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179679"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span id="inline"><span class="annot"><span class="annottext">inline :: forall name (uni :: * -&gt; *) fun (m :: * -&gt; *) a.
ExternalConstraints name uni fun m =&gt;
InlineHints name a
-&gt; Term name uni fun a -&gt; m (Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#inline"><span class="hs-identifier hs-var hs-var">inline</span></a></span></span><span> </span><span id="local-6989586621681179221"><span class="annot"><span class="annottext">InlineHints name a
</span><a href="#local-6989586621681179221"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span id="local-6989586621681179220"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179220"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><span id="line-122"></span><span>        </span><span class="annot"><a href="#local-6989586621681179219"><span class="hs-identifier hs-type">inlineInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-type">InlineInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179684"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179679"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span id="local-6989586621681179219"><span class="annot"><span class="annottext">inlineInfo :: InlineInfo name a
</span><a href="#local-6989586621681179219"><span class="hs-identifier hs-var hs-var">inlineInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name a. Usages -&gt; InlineHints name a -&gt; InlineInfo name a
</span><a href="UntypedPlutusCore.Transform.Inline.html#InlineInfo"><span class="hs-identifier hs-var">InlineInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681179218"><span class="hs-identifier hs-var">usgs</span></a></span><span> </span><span class="annot"><span class="annottext">InlineHints name a
</span><a href="#local-6989586621681179221"><span class="hs-identifier hs-var">hints</span></a></span><span>
</span><span id="line-124"></span><span>        </span><span class="annot"><a href="#local-6989586621681179218"><span class="hs-identifier hs-type">usgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Analysis.Usages.html#Usages"><span class="hs-identifier hs-type">Usages.Usages</span></a></span><span>
</span><span id="line-125"></span><span>        </span><span id="local-6989586621681179218"><span class="annot"><span class="annottext">usgs :: Usages
</span><a href="#local-6989586621681179218"><span class="hs-identifier hs-var hs-var">usgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
HasUnique name TermUnique =&gt;
Term name uni fun a -&gt; Usages
</span><a href="UntypedPlutusCore.Analysis.Usages.html#termUsages"><span class="hs-identifier hs-var">Usages.termUsages</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179220"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadQuote m =&gt; Quote a -&gt; m a
</span><a href="PlutusCore.Quote.html#liftQuote"><span class="hs-identifier hs-var">liftQuote</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">evalStateT</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><a href="../../../../transformers/html/src"><span class="hs-identifier hs-var">runReaderT</span></a></span><span> </span><span class="annot"><span class="annottext">InlineInfo name a
</span><a href="#local-6989586621681179219"><span class="hs-identifier hs-var">inlineInfo</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a -&gt; InlineM name uni fun a (Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179220"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="hs-comment">-- See Note [Differences from PIR inliner] 3</span><span>
</span><span id="line-129"></span><span class="hs-comment">{-| Extract the list of applications from a term, a bit like a &quot;multi-beta&quot; reduction.

Some examples will help:
[(\x . t) a] -&gt; Just ([(x, a)], t)

[[[(\x . (\y . (\z . t))) a] b] c] -&gt; Just ([(x, a), (y, b), (z, c)]) t)

[[(\x . t) a] b] -&gt; Nothing
-}</span><span>
</span><span id="line-138"></span><span id="local-6989586621681179637"><span id="local-6989586621681179638"><span id="local-6989586621681179639"><span id="local-6989586621681179640"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#extractApps"><span class="hs-identifier hs-type">extractApps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179640"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179639"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179638"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179637"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="UntypedPlutusCore.MkUPlc.html#UTermDef"><span class="hs-identifier hs-type">UTermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179640"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179639"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179638"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179637"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179640"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179639"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179638"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179637"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-139"></span><span id="extractApps"><span class="annot"><span class="annottext">extractApps :: forall name (uni :: * -&gt; *) fun a.
Term name uni fun a
-&gt; Maybe ([UTermDef name uni fun a], Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#extractApps"><span class="hs-identifier hs-var hs-var">extractApps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {name} {uni :: * -&gt; *} {fun} {ann}.
[Term name uni fun ann]
-&gt; Term name uni fun ann
-&gt; Maybe
     ([Def (UVarDecl name ann) (Term name uni fun ann)],
      Term name uni fun ann)
</span><a href="#local-6989586621681179210"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-141"></span><span>      </span><span id="local-6989586621681179210"><span class="annot"><span class="annottext">collectArgs :: [Term name uni fun ann]
-&gt; Term name uni fun ann
-&gt; Maybe
     ([Def (UVarDecl name ann) (Term name uni fun ann)],
      Term name uni fun ann)
</span><a href="#local-6989586621681179210"><span class="hs-identifier hs-var hs-var">collectArgs</span></a></span></span><span> </span><span id="local-6989586621681179209"><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179209"><span class="hs-identifier hs-var">argStack</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681179207"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179207"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681179206"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179206"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Term name uni fun ann]
-&gt; Term name uni fun ann
-&gt; Maybe
     ([Def (UVarDecl name ann) (Term name uni fun ann)],
      Term name uni fun ann)
</span><a href="#local-6989586621681179210"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179206"><span class="hs-identifier hs-var">arg</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179209"><span class="hs-identifier hs-var">argStack</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179207"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><a href="#local-6989586621681179210"><span class="hs-identifier hs-var">collectArgs</span></a></span><span> </span><span id="local-6989586621681179205"><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179205"><span class="hs-identifier hs-var">argStack</span></a></span></span><span> </span><span id="local-6989586621681179204"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179204"><span class="hs-identifier hs-var">t</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {val} {name} {ann} {uni :: * -&gt; *} {fun}.
[val]
-&gt; [Def (UVarDecl name ann) val]
-&gt; Term name uni fun ann
-&gt; Maybe ([Def (UVarDecl name ann) val], Term name uni fun ann)
</span><a href="#local-6989586621681179203"><span class="hs-identifier hs-var">matchArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179205"><span class="hs-identifier hs-var">argStack</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179204"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-143"></span><span>      </span><span id="local-6989586621681179203"><span class="annot"><span class="annottext">matchArgs :: [val]
-&gt; [Def (UVarDecl name ann) val]
-&gt; Term name uni fun ann
-&gt; Maybe ([Def (UVarDecl name ann) val], Term name uni fun ann)
</span><a href="#local-6989586621681179203"><span class="hs-identifier hs-var hs-var">matchArgs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681179200"><span class="annot"><span class="annottext">val
</span><a href="#local-6989586621681179200"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621681179199"><span class="annot"><span class="annottext">[val]
</span><a href="#local-6989586621681179199"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681179198"><span class="annot"><span class="annottext">[Def (UVarDecl name ann) val]
</span><a href="#local-6989586621681179198"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span id="local-6989586621681179196"><span class="annot"><span class="annottext">ann
</span><a href="#local-6989586621681179196"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681179195"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179195"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681179194"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179194"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[val]
-&gt; [Def (UVarDecl name ann) val]
-&gt; Term name uni fun ann
-&gt; Maybe ([Def (UVarDecl name ann) val], Term name uni fun ann)
</span><a href="#local-6989586621681179203"><span class="hs-identifier hs-var">matchArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[val]
</span><a href="#local-6989586621681179199"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall var val. var -&gt; val -&gt; Def var val
</span><a href="PlutusCore.MkPlc.html#Def"><span class="hs-identifier hs-var">Def</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name ann. ann -&gt; name -&gt; UVarDecl name ann
</span><a href="UntypedPlutusCore.Core.Type.html#UVarDecl"><span class="hs-identifier hs-var">UVarDecl</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><a href="#local-6989586621681179196"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179195"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">val
</span><a href="#local-6989586621681179200"><span class="hs-identifier hs-var">arg</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[Def (UVarDecl name ann) val]
</span><a href="#local-6989586621681179198"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179194"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-144"></span><span>      </span><span class="annot"><a href="#local-6989586621681179203"><span class="hs-identifier hs-var">matchArgs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span id="local-6989586621681179191"><span class="annot"><span class="annottext">[Def (UVarDecl name ann) val]
</span><a href="#local-6989586621681179191"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621681179190"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179190"><span class="hs-identifier hs-var">t</span></a></span></span><span>                 </span><span class="hs-glyph">=</span><span>
</span><span id="line-145"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[Def (UVarDecl name ann) val]
</span><a href="#local-6989586621681179191"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[Def (UVarDecl name ann) val]
</span><a href="#local-6989586621681179191"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179190"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><a href="#local-6989586621681179203"><span class="hs-identifier hs-var">matchArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">val
</span><span class="hs-identifier">_</span></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[val]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>      </span><span class="annot"><span class="annottext">[Def (UVarDecl name ann) val]
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><span class="hs-identifier">_</span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="hs-comment">-- | The inverse of 'extractApps'.</span><span>
</span><span id="line-149"></span><span id="local-6989586621681179614"><span id="local-6989586621681179615"><span id="local-6989586621681179616"><span id="local-6989586621681179617"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#restoreApps"><span class="hs-identifier hs-type">restoreApps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="UntypedPlutusCore.MkUPlc.html#UTermDef"><span class="hs-identifier hs-type">UTermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179617"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179616"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179615"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179614"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179617"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179616"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179615"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179614"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179617"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179616"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179615"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179614"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-150"></span><span id="restoreApps"><span class="annot"><span class="annottext">restoreApps :: forall name (uni :: * -&gt; *) fun a.
[UTermDef name uni fun a]
-&gt; Term name uni fun a -&gt; Term name uni fun a
</span><a href="UntypedPlutusCore.Transform.Inline.html#restoreApps"><span class="hs-identifier hs-var hs-var">restoreApps</span></a></span></span><span> </span><span id="local-6989586621681179186"><span class="annot"><span class="annottext">[UTermDef name uni fun a]
</span><a href="#local-6989586621681179186"><span class="hs-identifier hs-var">defs</span></a></span></span><span> </span><span id="local-6989586621681179185"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179185"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {name} {uni :: * -&gt; *} {fun} {ann}.
[Term name uni fun ann]
-&gt; Term name uni fun ann
-&gt; [Def (UVarDecl name ann) (Term name uni fun ann)]
-&gt; Term name uni fun ann
</span><a href="#local-6989586621681179184"><span class="hs-identifier hs-var">makeLams</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179185"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[UTermDef name uni fun a]
</span><a href="#local-6989586621681179186"><span class="hs-identifier hs-var">defs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-152"></span><span>      </span><span id="local-6989586621681179184"><span class="annot"><span class="annottext">makeLams :: [Term name uni fun ann]
-&gt; Term name uni fun ann
-&gt; [Def (UVarDecl name ann) (Term name uni fun ann)]
-&gt; Term name uni fun ann
</span><a href="#local-6989586621681179184"><span class="hs-identifier hs-var hs-var">makeLams</span></a></span></span><span> </span><span id="local-6989586621681179183"><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179183"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681179182"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179182"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.MkPlc.html#Def"><span class="hs-identifier hs-type">Def</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#UVarDecl"><span class="hs-identifier hs-type">UVarDecl</span></a></span><span> </span><span id="local-6989586621681179181"><span class="annot"><span class="annottext">ann
</span><a href="#local-6989586621681179181"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681179180"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179180"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681179179"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179179"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621681179178"><span class="annot"><span class="annottext">[Def (UVarDecl name ann) (Term name uni fun ann)]
</span><a href="#local-6989586621681179178"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Term name uni fun ann]
-&gt; Term name uni fun ann
-&gt; [Def (UVarDecl name ann) (Term name uni fun ann)]
-&gt; Term name uni fun ann
</span><a href="#local-6989586621681179184"><span class="hs-identifier hs-var">makeLams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179179"><span class="hs-identifier hs-var">rhs</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179183"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun ann.
ann -&gt; name -&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-var">LamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><a href="#local-6989586621681179181"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179180"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179182"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Def (UVarDecl name ann) (Term name uni fun ann)]
</span><a href="#local-6989586621681179178"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-153"></span><span>      </span><span class="annot"><a href="#local-6989586621681179184"><span class="hs-identifier hs-var">makeLams</span></a></span><span> </span><span id="local-6989586621681179177"><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179177"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681179176"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179176"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {name} {uni :: * -&gt; *} {fun} {ann}.
[Term name uni fun ann]
-&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="#local-6989586621681179175"><span class="hs-identifier hs-var">makeApps</span></a></span><span> </span><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179177"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179176"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-comment">-- This isn't the best annotation, but it will do</span><span>
</span><span id="line-155"></span><span>      </span><span id="local-6989586621681179175"><span class="annot"><span class="annottext">makeApps :: [Term name uni fun ann]
-&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="#local-6989586621681179175"><span class="hs-identifier hs-var hs-var">makeApps</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681179174"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179174"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621681179173"><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179173"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681179172"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179172"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Term name uni fun ann]
-&gt; Term name uni fun ann -&gt; Term name uni fun ann
</span><a href="#local-6989586621681179175"><span class="hs-identifier hs-var">makeApps</span></a></span><span> </span><span class="annot"><span class="annottext">[Term name uni fun ann]
</span><a href="#local-6989586621681179173"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun ann.
ann
-&gt; Term name uni fun ann
-&gt; Term name uni fun ann
-&gt; Term name uni fun ann
</span><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun ann. Term name uni fun ann -&gt; ann
</span><a href="UntypedPlutusCore.Core.Type.html#termAnn"><span class="hs-identifier hs-var">termAnn</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179172"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179172"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179174"><span class="hs-identifier hs-var">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>      </span><span class="annot"><a href="#local-6989586621681179175"><span class="hs-identifier hs-var">makeApps</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621681179170"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179170"><span class="hs-identifier hs-var">acc</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681179170"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="hs-comment">-- | Run the inliner on a `UntypedPlutusCore.Core.Type.Term`.</span><span>
</span><span id="line-159"></span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#processTerm"><span class="hs-identifier hs-type">processTerm</span></a></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681179645"><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179644"><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179643"><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179642"><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span id="processTerm"><span class="annot"><span class="annottext">processTerm :: forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a -&gt; InlineM name uni fun a (Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var hs-var">processTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term name uni fun a -&gt; InlineM name uni fun a (Term name uni fun a)
</span><a href="#local-6989586621681179123"><span class="hs-identifier hs-var">handleTerm</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><a href="#local-6989586621681179123"><span class="hs-identifier hs-type">handleTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>    </span><span id="local-6989586621681179123"><span class="annot"><span class="annottext">handleTerm :: Term name uni fun a -&gt; InlineM name uni fun a (Term name uni fun a)
</span><a href="#local-6989586621681179123"><span class="hs-identifier hs-var hs-var">handleTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-166"></span><span>        </span><span id="local-6989586621681179122"><span class="annot"><span class="annottext">v :: Term name uni fun a
</span><a href="#local-6989586621681179122"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681179120"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179120"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179122"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">name -&gt; InlineM name uni fun a (Maybe (Term name uni fun a))
</span><a href="#local-6989586621681179117"><span class="hs-identifier hs-var">substName</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179120"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-comment">-- See Note [Differences from PIR inliner] 3</span><span>
</span><span id="line-168"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
Term name uni fun a
-&gt; Maybe ([UTermDef name uni fun a], Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#extractApps"><span class="hs-identifier hs-var">extractApps</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681179116"><span class="annot"><span class="annottext">[UTermDef name uni fun a]
</span><a href="#local-6989586621681179116"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681179115"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179115"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-169"></span><span>            </span><span id="local-6989586621681179114"><span class="annot"><span class="annottext">[UTermDef name uni fun a]
</span><a href="#local-6989586621681179114"><span class="hs-identifier hs-var">bs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Witherable t, Applicative f) =&gt;
(a -&gt; f (Maybe b)) -&gt; t a -&gt; f (t b)
</span><a href="../../../../witherable/html/src"><span class="hs-identifier hs-var">wither</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a
-&gt; UTermDef name uni fun a
-&gt; InlineM name uni fun a (Maybe (UTermDef name uni fun a))
</span><a href="UntypedPlutusCore.Transform.Inline.html#processSingleBinding"><span class="hs-identifier hs-var">processSingleBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179115"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[UTermDef name uni fun a]
</span><a href="#local-6989586621681179116"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-170"></span><span>            </span><span id="local-6989586621681179112"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179112"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a -&gt; InlineM name uni fun a (Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179115"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-171"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
[UTermDef name uni fun a]
-&gt; Term name uni fun a -&gt; Term name uni fun a
</span><a href="UntypedPlutusCore.Transform.Inline.html#restoreApps"><span class="hs-identifier hs-var">restoreApps</span></a></span><span> </span><span class="annot"><span class="annottext">[UTermDef name uni fun a]
</span><a href="#local-6989586621681179114"><span class="hs-identifier hs-var">bs'</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179112"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-172"></span><span>        </span><span id="local-6989586621681179111"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179111"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) s t a b.
LensLike (WrappedMonad m) s t a b -&gt; s -&gt; (a -&gt; m b) -&gt; m t
</span><a href="../../../../lens/html/src"><span class="hs-identifier hs-var">forMOf</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun ann.
Traversal' (Term name uni fun ann) (Term name uni fun ann)
</span><a href="UntypedPlutusCore.Core.Plated.html#termSubterms"><span class="hs-identifier hs-var">termSubterms</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179111"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a -&gt; InlineM name uni fun a (Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-comment">-- See Note [Renaming strategy]</span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><a href="#local-6989586621681179117"><span class="hs-identifier hs-type">substName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>    </span><span id="local-6989586621681179117"><span class="annot"><span class="annottext">substName :: name -&gt; InlineM name uni fun a (Maybe (Term name uni fun a))
</span><a href="#local-6989586621681179117"><span class="hs-identifier hs-var hs-var">substName</span></a></span></span><span> </span><span id="local-6989586621681179108"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179108"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
HasUnique name TermUnique =&gt;
name -&gt; Subst name uni fun a -&gt; Maybe (InlineTerm name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#lookupTerm"><span class="hs-identifier hs-var">lookupTerm</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179108"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">InlineTerm name uni fun a
-&gt; InlineM name uni fun a (Term name uni fun a)
</span><a href="#local-6989586621681179105"><span class="hs-identifier hs-var">renameTerm</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-comment">-- See Note [Inlining approach and 'Secrets of the GHC Inliner']</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><a href="#local-6989586621681179105"><span class="hs-identifier hs-type">renameTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179645"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179644"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179643"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179642"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621681179105"><span class="annot"><span class="annottext">renameTerm :: InlineTerm name uni fun a
-&gt; InlineM name uni fun a (Term name uni fun a)
</span><a href="#local-6989586621681179105"><span class="hs-identifier hs-var hs-var">renameTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-comment">-- Already processed term, just rename and put it in, don't do any</span><span>
</span><span id="line-181"></span><span>        </span><span class="hs-comment">-- further optimization here.</span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#Done"><span class="hs-identifier hs-type">Done</span></a></span><span> </span><span id="local-6989586621681179104"><span class="annot"><span class="annottext">Dupable (Term name uni fun a)
</span><a href="#local-6989586621681179104"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadQuote m, Rename a) =&gt;
Dupable a -&gt; m a
</span><a href="PlutusCore.Rename.html#liftDupable"><span class="hs-identifier hs-var">liftDupable</span></a></span><span> </span><span class="annot"><span class="annottext">Dupable (Term name uni fun a)
</span><a href="#local-6989586621681179104"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span id="local-6989586621681179545"><span id="local-6989586621681179546"><span id="local-6989586621681179547"><span id="local-6989586621681179548"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#processSingleBinding"><span class="hs-identifier hs-type">processSingleBinding</span></a></span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179548"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179547"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179546"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179548"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179547"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179546"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179545"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.MkUPlc.html#UTermDef"><span class="hs-identifier hs-type">UTermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179548"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179547"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179546"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179545"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179548"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179547"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179546"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179545"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.MkUPlc.html#UTermDef"><span class="hs-identifier hs-type">UTermDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179548"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179547"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179546"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179545"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-189"></span><span id="processSingleBinding"><span class="annot"><span class="annottext">processSingleBinding :: forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a
-&gt; UTermDef name uni fun a
-&gt; InlineM name uni fun a (Maybe (UTermDef name uni fun a))
</span><a href="UntypedPlutusCore.Transform.Inline.html#processSingleBinding"><span class="hs-identifier hs-var hs-var">processSingleBinding</span></a></span></span><span> </span><span id="local-6989586621681179091"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179091"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.MkPlc.html#Def"><span class="hs-identifier hs-type">Def</span></a></span><span> </span><span id="local-6989586621681179090"><span class="annot"><span class="annottext">vd :: UVarDecl name a
</span><a href="#local-6989586621681179090"><span class="hs-identifier hs-var">vd</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#UVarDecl"><span class="hs-identifier hs-type">UVarDecl</span></a></span><span> </span><span id="local-6989586621681179089"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681179089"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681179088"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179088"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681179087"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179087"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-190"></span><span>    </span><span id="local-6989586621681179086"><span class="annot"><span class="annottext">Maybe (Term name uni fun a)
</span><a href="#local-6989586621681179086"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a
-&gt; a
-&gt; name
-&gt; Term name uni fun a
-&gt; InlineM name uni fun a (Maybe (Term name uni fun a))
</span><a href="UntypedPlutusCore.Transform.Inline.html#maybeAddSubst"><span class="hs-identifier hs-var">maybeAddSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179091"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681179089"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179088"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179087"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall var val. var -&gt; val -&gt; Def var val
</span><a href="PlutusCore.MkPlc.html#Def"><span class="hs-identifier hs-var">Def</span></a></span><span> </span><span class="annot"><span class="annottext">UVarDecl name a
</span><a href="#local-6989586621681179090"><span class="hs-identifier hs-var">vd</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Term name uni fun a)
</span><a href="#local-6989586621681179086"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="hs-comment">-- | Check against the heuristics we have for inlining and either inline the term binding or not.</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- The arguments to this function are the fields of the `TermBinding` being processed.</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- Nothing means that we are inlining the term:</span><span>
</span><span id="line-196"></span><span class="hs-comment">--   * we have extended the substitution, and</span><span>
</span><span id="line-197"></span><span class="hs-comment">--   * we are removing the binding (hence we return Nothing).</span><span>
</span><span id="line-198"></span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#maybeAddSubst"><span class="hs-identifier hs-type">maybeAddSubst</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681179514"><span class="annot"><a href="#local-6989586621681179514"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179513"><span class="annot"><a href="#local-6989586621681179513"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179512"><span class="annot"><a href="#local-6989586621681179512"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179511"><span class="annot"><a href="#local-6989586621681179511"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179514"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179513"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179512"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179514"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179513"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179512"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179511"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681179511"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681179514"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-203"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179514"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179513"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179512"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179511"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179514"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179513"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179512"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179511"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179514"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179513"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179512"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179511"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span id="maybeAddSubst"><span class="annot"><span class="annottext">maybeAddSubst :: forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a
-&gt; a
-&gt; name
-&gt; Term name uni fun a
-&gt; InlineM name uni fun a (Maybe (Term name uni fun a))
</span><a href="UntypedPlutusCore.Transform.Inline.html#maybeAddSubst"><span class="hs-identifier hs-var hs-var">maybeAddSubst</span></a></span></span><span> </span><span id="local-6989586621681179062"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179062"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621681179061"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681179061"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681179060"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179060"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681179059"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179059"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-206"></span><span>    </span><span id="local-6989586621681179058"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179058"><span class="hs-identifier hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a -&gt; InlineM name uni fun a (Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#processTerm"><span class="hs-identifier hs-var">processTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179059"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-comment">-- Check whether we've been told specifically to inline this</span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621681179057"><span class="annot"><span class="annottext">InlineHints name a
</span><a href="#local-6989586621681179057"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">asks</span></a></span><span> </span><span class="annot"><span class="annottext">forall name a. InlineInfo name a -&gt; InlineHints name a
</span><a href="UntypedPlutusCore.Transform.Inline.html#_hints"><span class="hs-identifier hs-var">_hints</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681179055"><span class="annot"><span class="annottext">hinted :: Bool
</span><a href="#local-6989586621681179055"><span class="hs-identifier hs-var hs-var">hinted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name a. InlineHints name a -&gt; a -&gt; name -&gt; Bool
</span><a href="PlutusCore.Annotation.html#shouldInline"><span class="hs-identifier hs-var">shouldInline</span></a></span><span> </span><span class="annot"><span class="annottext">InlineHints name a
</span><a href="#local-6989586621681179057"><span class="hs-identifier hs-var">hints</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681179061"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179060"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681179055"><span class="hs-identifier hs-var">hinted</span></a></span><span> </span><span class="hs-comment">-- if we've been told specifically, then do it right away</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall b.
InlineTerm name uni fun a -&gt; InlineM name uni fun a (Maybe b)
</span><a href="#local-6989586621681179053"><span class="hs-identifier hs-var">extendAndDrop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
Dupable (Term name uni fun a) -&gt; InlineTerm name uni fun a
</span><a href="UntypedPlutusCore.Transform.Inline.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Dupable a
</span><a href="PlutusCore.Rename.html#dupable"><span class="hs-identifier hs-var">dupable</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179058"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621681179052"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681179052"><span class="hs-identifier hs-var">termIsPure</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
Term name uni fun a -&gt; InlineM name uni fun a Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#checkPurity"><span class="hs-identifier hs-var">checkPurity</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179058"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span id="local-6989586621681179050"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681179050"><span class="hs-identifier hs-var">preUnconditional</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a1 a2 r.
Monad m =&gt;
(a1 -&gt; a2 -&gt; r) -&gt; m a1 -&gt; m a2 -&gt; m r
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">liftM2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">(&amp;&amp;)</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
name -&gt; InlineM name uni fun a Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#nameUsedAtMostOnce"><span class="hs-identifier hs-var">nameUsedAtMostOnce</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179060"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a -&gt; name -&gt; Bool -&gt; InlineM name uni fun a Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#effectSafe"><span class="hs-identifier hs-var">effectSafe</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179062"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179060"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681179052"><span class="hs-identifier hs-var">termIsPure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-comment">-- similar to the paper, preUnconditional inlining checks that the binder is 'OnceSafe'.</span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-comment">-- I.e., it's used at most once AND it neither duplicate code or work.</span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-comment">-- While we don't check for lambda etc like in the paper, `effectSafe` ensures that it</span><span>
</span><span id="line-220"></span><span>        </span><span class="hs-comment">-- isn't doing any substantial work.</span><span>
</span><span id="line-221"></span><span>        </span><span class="hs-comment">-- We actually also inline 'Dead' binders (i.e., remove dead code) here.</span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681179050"><span class="hs-identifier hs-var">preUnconditional</span></a></span><span>
</span><span id="line-223"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall b.
InlineTerm name uni fun a -&gt; InlineM name uni fun a (Maybe b)
</span><a href="#local-6989586621681179053"><span class="hs-identifier hs-var">extendAndDrop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
Dupable (Term name uni fun a) -&gt; InlineTerm name uni fun a
</span><a href="UntypedPlutusCore.Transform.Inline.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Dupable a
</span><a href="PlutusCore.Rename.html#dupable"><span class="hs-identifier hs-var">dupable</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179058"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-225"></span><span>            </span><span class="hs-comment">-- See Note [Inlining approach and 'Secrets of the GHC Inliner'] and [Inlining and</span><span>
</span><span id="line-226"></span><span>            </span><span class="hs-comment">-- purity]. This is the case where we don't know that the number of occurrences is</span><span>
</span><span id="line-227"></span><span>            </span><span class="hs-comment">-- exactly one, so there's no point checking if the term is immediately evaluated.</span><span>
</span><span id="line-228"></span><span>            </span><span id="local-6989586621681179045"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681179045"><span class="hs-identifier hs-var">postUnconditional</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">(&amp;&amp;)</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681179052"><span class="hs-identifier hs-var">termIsPure</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
Term name uni fun a -&gt; InlineM name uni fun a Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#acceptable"><span class="hs-identifier hs-var">acceptable</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179058"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681179045"><span class="hs-identifier hs-var">postUnconditional</span></a></span><span>
</span><span id="line-230"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall b.
InlineTerm name uni fun a -&gt; InlineM name uni fun a (Maybe b)
</span><a href="#local-6989586621681179053"><span class="hs-identifier hs-var">extendAndDrop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
Dupable (Term name uni fun a) -&gt; InlineTerm name uni fun a
</span><a href="UntypedPlutusCore.Transform.Inline.html#Done"><span class="hs-identifier hs-var">Done</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Dupable a
</span><a href="PlutusCore.Rename.html#dupable"><span class="hs-identifier hs-var">dupable</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179058"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179058"><span class="hs-identifier hs-var">rhs'</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-233"></span><span>        </span><span class="annot"><a href="#local-6989586621681179053"><span class="hs-identifier hs-type">extendAndDrop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-234"></span><span>            </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681179498"><span class="annot"><a href="#local-6989586621681179498"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineTerm"><span class="hs-identifier hs-type">InlineTerm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179514"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179513"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179512"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179511"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-235"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179514"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179513"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179512"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179511"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179498"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>        </span><span id="local-6989586621681179053"><span class="annot"><span class="annottext">extendAndDrop :: forall b.
InlineTerm name uni fun a -&gt; InlineM name uni fun a (Maybe b)
</span><a href="#local-6989586621681179053"><span class="hs-identifier hs-var hs-var">extendAndDrop</span></a></span></span><span> </span><span id="local-6989586621681179038"><span class="annot"><span class="annottext">InlineTerm name uni fun a
</span><a href="#local-6989586621681179038"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">modify'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
HasUnique name TermUnique =&gt;
name
-&gt; InlineTerm name uni fun a
-&gt; Subst name uni fun a
-&gt; Subst name uni fun a
</span><a href="UntypedPlutusCore.Transform.Inline.html#extendTerm"><span class="hs-identifier hs-var">extendTerm</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179060"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">InlineTerm name uni fun a
</span><a href="#local-6989586621681179038"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="hs-comment">-- | Check if term is pure. See Note [Inlining and purity]</span><span>
</span><span id="line-239"></span><span id="local-6989586621681179489"><span id="local-6989586621681179490"><span id="local-6989586621681179491"><span id="local-6989586621681179492"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#checkPurity"><span class="hs-identifier hs-type">checkPurity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179492"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179491"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179490"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179489"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179492"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179491"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179490"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179489"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span><span>
</span><span id="line-240"></span><span id="checkPurity"><span class="annot"><span class="annottext">checkPurity :: forall name (uni :: * -&gt; *) fun a.
Term name uni fun a -&gt; InlineM name uni fun a Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#checkPurity"><span class="hs-identifier hs-var hs-var">checkPurity</span></a></span></span><span> </span><span id="local-6989586621681179030"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179030"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a. Term name uni fun a -&gt; Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#isPure"><span class="hs-identifier hs-var">isPure</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179030"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#nameUsedAtMostOnce"><span class="hs-identifier hs-type">nameUsedAtMostOnce</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681179484"><span class="annot"><a href="#local-6989586621681179484"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179483"><span class="annot"><a href="#local-6989586621681179483"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179482"><span class="annot"><a href="#local-6989586621681179482"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179481"><span class="annot"><a href="#local-6989586621681179481"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179484"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179483"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179482"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681179484"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179484"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179483"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179482"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179481"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-245"></span><span id="nameUsedAtMostOnce"><span class="annot"><span class="annottext">nameUsedAtMostOnce :: forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
name -&gt; InlineM name uni fun a Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#nameUsedAtMostOnce"><span class="hs-identifier hs-var hs-var">nameUsedAtMostOnce</span></a></span></span><span> </span><span id="local-6989586621681179014"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179014"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>    </span><span id="local-6989586621681179013"><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681179013"><span class="hs-identifier hs-var">usgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">asks</span></a></span><span> </span><span class="annot"><span class="annottext">forall name a. InlineInfo name a -&gt; Usages
</span><a href="UntypedPlutusCore.Transform.Inline.html#_usages"><span class="hs-identifier hs-var">_usages</span></a></span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-comment">-- 'inlining' terms used 0 times is a cheap way to remove dead code while we're here</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall n unique. HasUnique n unique =&gt; n -&gt; Usages -&gt; Int
</span><a href="UntypedPlutusCore.Analysis.Usages.html#getUsageCount"><span class="hs-identifier hs-var">Usages.getUsageCount</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179014"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621681179013"><span class="hs-identifier hs-var">usgs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#effectSafe"><span class="hs-identifier hs-type">effectSafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621681179480"><span class="annot"><a href="#local-6989586621681179480"><span class="hs-identifier hs-type">name</span></a></span></span><span> </span><span id="local-6989586621681179479"><span class="annot"><a href="#local-6989586621681179479"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621681179478"><span class="annot"><a href="#local-6989586621681179478"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span id="local-6989586621681179477"><span class="annot"><a href="#local-6989586621681179477"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InliningConstraints"><span class="hs-identifier hs-type">InliningConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179480"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179479"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179478"><span class="hs-identifier hs-type">fun</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179480"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179479"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179478"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179477"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681179480"><span class="hs-identifier hs-type">name</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-comment">-- ^ is it pure?</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179480"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179479"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179478"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179477"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-255"></span><span id="effectSafe"><span class="annot"><span class="annottext">effectSafe :: forall name (uni :: * -&gt; *) fun a.
InliningConstraints name uni fun =&gt;
Term name uni fun a -&gt; name -&gt; Bool -&gt; InlineM name uni fun a Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#effectSafe"><span class="hs-identifier hs-var hs-var">effectSafe</span></a></span></span><span> </span><span id="local-6989586621681179001"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179001"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621681179000"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179000"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681178999"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681178999"><span class="hs-identifier hs-var">purity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-comment">-- This can in the worst case traverse a lot of the term, which could lead to us</span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-comment">-- doing ~quadratic work as we process the program. However in practice most term</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-comment">-- types will make it give up, so it's not too bad.</span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681178998"><span class="annot"><span class="annottext">immediatelyEvaluated :: Bool
</span><a href="#local-6989586621681178998"><span class="hs-identifier hs-var hs-var">immediatelyEvaluated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
Term name uni fun a -&gt; Maybe (Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#firstEffectfulTerm"><span class="hs-identifier hs-var">firstEffectfulTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681179001"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-260"></span><span>            </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681178996"><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681178996"><span class="hs-identifier hs-var">n'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681179000"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">name
</span><a href="#local-6989586621681178996"><span class="hs-identifier hs-var">n'</span></a></span><span>
</span><span id="line-261"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Term name uni fun a)
</span><span class="hs-identifier">_</span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681178999"><span class="hs-identifier hs-var">purity</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681178998"><span class="hs-identifier hs-var">immediatelyEvaluated</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="hs-comment">-- | Should we inline? Should only inline things that won't duplicate work or code.</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- See Note [Inlining approach and 'Secrets of the GHC Inliner']</span><span>
</span><span id="line-266"></span><span id="local-6989586621681178991"><span id="local-6989586621681178992"><span id="local-6989586621681178993"><span id="local-6989586621681178994"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#acceptable"><span class="hs-identifier hs-type">acceptable</span></a></span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178994"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178993"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178992"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178991"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#InlineM"><span class="hs-identifier hs-type">InlineM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178994"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178993"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178992"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178991"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span><span>
</span><span id="line-267"></span><span id="acceptable"><span class="annot"><span class="annottext">acceptable :: forall name (uni :: * -&gt; *) fun a.
Term name uni fun a -&gt; InlineM name uni fun a Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#acceptable"><span class="hs-identifier hs-var hs-var">acceptable</span></a></span></span><span> </span><span id="local-6989586621681178984"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681178984"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-comment">-- See Note [Inlining criteria]</span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a. Term name uni fun a -&gt; Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#costIsAcceptable"><span class="hs-identifier hs-var">costIsAcceptable</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681178984"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a. Term name uni fun a -&gt; Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#sizeIsAcceptable"><span class="hs-identifier hs-var">sizeIsAcceptable</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681178984"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="hs-comment">{- |
Try to identify the first sub term which will be evaluated in the given term and
which could have an effect. 'Nothing' indicates that we don't know, this function
is conservative.
-}</span><span>
</span><span id="line-276"></span><span id="local-6989586621681179446"><span id="local-6989586621681179447"><span id="local-6989586621681179448"><span id="local-6989586621681179449"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#firstEffectfulTerm"><span class="hs-identifier hs-type">firstEffectfulTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179449"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179448"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179447"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179446"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179449"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179448"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179447"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179446"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-277"></span><span id="firstEffectfulTerm"><span class="annot"><span class="annottext">firstEffectfulTerm :: forall name (uni :: * -&gt; *) fun a.
Term name uni fun a -&gt; Maybe (Term name uni fun a)
</span><a href="UntypedPlutusCore.Transform.Inline.html#firstEffectfulTerm"><span class="hs-identifier hs-var hs-var">firstEffectfulTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a.
Term name uni fun a -&gt; Maybe (Term name uni fun a)
</span><a href="#local-6989586621681178981"><span class="hs-identifier hs-var">goTerm</span></a></span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-279"></span><span>      </span><span id="local-6989586621681178981"><span class="annot"><span class="annottext">goTerm :: Term name uni fun ann -&gt; Maybe (Term name uni fun ann)
</span><a href="#local-6989586621681178981"><span class="hs-identifier hs-var hs-var">goTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681178980"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178980"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann -&gt; Maybe (Term name uni fun ann)
</span><a href="#local-6989586621681178981"><span class="hs-identifier hs-var">goTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178980"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Force"><span class="hs-identifier hs-type">Force</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681178978"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178978"><span class="hs-identifier hs-var">t</span></a></span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann -&gt; Maybe (Term name uni fun ann)
</span><a href="#local-6989586621681178981"><span class="hs-identifier hs-var">goTerm</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178978"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>        </span><span id="local-6989586621681178977"><span class="annot"><span class="annottext">t :: Term name uni fun ann
</span><a href="#local-6989586621681178977"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178977"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-285"></span><span>        </span><span id="local-6989586621681178976"><span class="annot"><span class="annottext">t :: Term name uni fun ann
</span><a href="#local-6989586621681178976"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178976"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-286"></span><span>        </span><span id="local-6989586621681178974"><span class="annot"><span class="annottext">t :: Term name uni fun ann
</span><a href="#local-6989586621681178974"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178974"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-290"></span><span>        </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Delay"><span class="hs-identifier hs-type">Delay</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span class="hs-comment">-- | Is the cost increase (in terms of evaluation work) of inlining a variable whose RHS is</span><span>
</span><span id="line-293"></span><span class="hs-comment">-- the given term acceptable?</span><span>
</span><span id="line-294"></span><span id="local-6989586621681178967"><span id="local-6989586621681178968"><span id="local-6989586621681178969"><span id="local-6989586621681178970"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#costIsAcceptable"><span class="hs-identifier hs-type">costIsAcceptable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178970"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178969"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178968"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178967"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span><span>
</span><span id="line-295"></span><span id="costIsAcceptable"><span class="annot"><span class="annottext">costIsAcceptable :: forall name (uni :: * -&gt; *) fun a. Term name uni fun a -&gt; Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#costIsAcceptable"><span class="hs-identifier hs-var hs-var">costIsAcceptable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-298"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-comment">-- This will mean that we create closures at each use site instead of</span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-comment">-- once, but that's a very low cost which we're okay rounding to 0.</span><span>
</span><span id="line-302"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Force"><span class="hs-identifier hs-type">Force</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Delay"><span class="hs-identifier hs-type">Delay</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="hs-comment">-- | Is the size increase (in the AST) of inlining a variable whose RHS is</span><span>
</span><span id="line-310"></span><span class="hs-comment">-- the given term acceptable?</span><span>
</span><span id="line-311"></span><span id="local-6989586621681178963"><span id="local-6989586621681178964"><span id="local-6989586621681178965"><span id="local-6989586621681178966"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#sizeIsAcceptable"><span class="hs-identifier hs-type">sizeIsAcceptable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178966"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178965"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178964"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681178963"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span><span>
</span><span id="line-312"></span><span id="sizeIsAcceptable"><span class="annot"><span class="annottext">sizeIsAcceptable :: forall name (uni :: * -&gt; *) fun a. Term name uni fun a -&gt; Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#sizeIsAcceptable"><span class="hs-identifier hs-var hs-var">sizeIsAcceptable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-313"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-314"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-315"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Error"><span class="hs-identifier hs-type">Error</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-comment">-- See Note [Differences from PIR inliner] 4</span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-comment">-- Constants can be big! We could check the size here and inline if they're</span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-comment">-- small, but probably not worth it</span><span>
</span><span id="line-322"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-323"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Force"><span class="hs-identifier hs-type">Force</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681178962"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681178962"><span class="hs-identifier hs-var">t</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a. Term name uni fun a -&gt; Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#sizeIsAcceptable"><span class="hs-identifier hs-var">sizeIsAcceptable</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681178962"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-326"></span><span>  </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Delay"><span class="hs-identifier hs-type">Delay</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681178961"><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681178961"><span class="hs-identifier hs-var">t</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall name (uni :: * -&gt; *) fun a. Term name uni fun a -&gt; Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#sizeIsAcceptable"><span class="hs-identifier hs-var">sizeIsAcceptable</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun a
</span><a href="#local-6989586621681178961"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span id="local-6989586621681179461"><span id="local-6989586621681179462"><span id="local-6989586621681179463"><span id="local-6989586621681179464"><span class="annot"><a href="UntypedPlutusCore.Transform.Inline.html#isPure"><span class="hs-identifier hs-type">isPure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179464"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179463"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179462"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681179461"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span></span></span></span></span><span>
</span><span id="line-329"></span><span id="isPure"><span class="annot"><span class="annottext">isPure :: forall name (uni :: * -&gt; *) fun a. Term name uni fun a -&gt; Bool
</span><a href="UntypedPlutusCore.Transform.Inline.html#isPure"><span class="hs-identifier hs-var hs-var">isPure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {name} {uni :: * -&gt; *} {fun} {ann}.
Bool -&gt; Term name uni fun ann -&gt; Bool
</span><a href="#local-6989586621681178960"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-comment">-- See Note [delayAndVarIsPure]</span><span>
</span><span id="line-332"></span><span>        </span><span id="local-6989586621681178960"><span class="annot"><span class="annottext">go :: Bool -&gt; Term name uni fun ann -&gt; Bool
</span><a href="#local-6989586621681178960"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681178959"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681178959"><span class="hs-identifier hs-var">delayAndVarIsPure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-333"></span><span>            </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681178959"><span class="hs-identifier hs-var">delayAndVarIsPure</span></a></span><span>
</span><span id="line-334"></span><span>            </span><span class="hs-comment">-- These are syntactically values that won't reduce further</span><span>
</span><span id="line-335"></span><span>            </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-336"></span><span>            </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-337"></span><span>            </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Delay"><span class="hs-identifier hs-type">Delay</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681178958"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178958"><span class="hs-identifier hs-var">body</span></a></span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681178959"><span class="hs-identifier hs-var">delayAndVarIsPure</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Term name uni fun ann -&gt; Bool
</span><a href="#local-6989586621681178960"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681178959"><span class="hs-identifier hs-var">delayAndVarIsPure</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178958"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-338"></span><span>            </span><span class="hs-comment">-- This case is not needed in PIR's `isPure`, because PIR's beta-reduction pass</span><span>
</span><span id="line-339"></span><span>            </span><span class="hs-comment">-- turns terms like this into `Let` bindings.</span><span>
</span><span id="line-340"></span><span>            </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#LamAbs"><span class="hs-identifier hs-type">LamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">name
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681178957"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178957"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681178956"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178956"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Term name uni fun ann -&gt; Bool
</span><a href="#local-6989586621681178960"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178956"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Term name uni fun ann -&gt; Bool
</span><a href="#local-6989586621681178960"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681178959"><span class="hs-identifier hs-var">delayAndVarIsPure</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178957"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-341"></span><span>            </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Force"><span class="hs-identifier hs-type">Force</span></a></span><span> </span><span class="annot"><span class="annottext">ann
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681178955"><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178955"><span class="hs-identifier hs-var">body</span></a></span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Term name uni fun ann -&gt; Bool
</span><a href="#local-6989586621681178960"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><a href="#local-6989586621681178955"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-342"></span><span>            </span><span class="hs-comment">-- See Note [Differences from PIR inliner] 5</span><span>
</span><span id="line-343"></span><span>            </span><span class="annot"><a href="UntypedPlutusCore.Core.Type.html#Builtin"><span class="hs-identifier hs-type">Builtin</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-344"></span><span>            </span><span class="annot"><span class="annottext">Term name uni fun ann
</span><span class="hs-identifier">_</span></span><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span class="hs-comment">{- Note [delayAndVarIsPure]

To determine whether a `Term` is pure, we recurse into the `Term`. If we do not descend
into a `Force` node, then a `Var` node and a `Delay` node is always pure
(see Note [Purity, strictness, and variables] for why `Var` nodes are pure).

Once we descend into the body of a `Force` node, however, `Var` and `Delay` nodes can
no longer be considered unconditionally pure, because the following terms are impure:

```
force (delay impure)
force (force (delay (delay impure)))
force x  -- because `x` may expand into an impure `Term`
force (force (delay x))
```

This is the purpose of the `delayAndVarIsPure` flag, which is set to `False` when
descending into the body of `Force`.

This can potentially be improved, e.g., it would consider the following pure terms
as impure:

```
force (delay (delay impure))
force (delay x)
```

However, since we can rely on `forceDelayCancel` to cancel adjacent `force` and `delay`
nodes, we do not need to be too clever here.
-}</span><span>
</span><span id="line-376"></span></pre></body></html>